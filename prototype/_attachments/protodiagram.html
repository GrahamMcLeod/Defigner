<html>
  <head>
    <title>Force-Directed Layout</title>
    
    <script type="text/javascript" src="protovis-d3.2.js"></script>
     <script src="jquery.min.js"></script>
     <script src="myutils.js"></script>

    <script type="text/javascript" src= "prototype.js"></script>
    <script type="text/javascript" src= "examples.js"></script>
    
    <style type="text/css">

body {
  margin: 0;
}

    </style>
  </head>
  <body>
    <script type="text/javascript+protovis">
  // Define functions 
  // Fetch a collection of objects from the store using a named starting point and following 1 level of relationships 
  var fetchGraph = function (startURI, nodes, links)  {
  	  var startNode = thingStore.lookup(startURI);
  	  if (startNode) {
  	    var tempNode = {nodeName: startNode.property(label), 
  	                    group: 1, uri: startNode.uri};
  	    nodes.push(tempNode);
  	    var rels = startNode.properties().filter(function(each){return each.ofType(relationship)});
        rels.forEach(function(each)
             {tempNode = {nodeName: startNode.property(each).property(label), 
  	                    group: 1, uri: startNode.property(each).uri};
              var targetIdx = (nodes.push(tempNode) - 1);
              var tempLink = {source:0, target:targetIdx, value:1, relName: each.property(label)};
              links.push(tempLink);
              }
        )      
      
      }
  };
  // Initialise Panel
  var vis;
  // Render graph of retrieved objects on browser
  var renderGraph=function (startItem, tempNodes, tempLinks) {
  fetchGraph(startItem, tempNodes, tempLinks);
  var items = {
        nodes: tempNodes,
        links: tempLinks   
   };      

   var w = document.body.clientWidth,
       h = document.body.clientHeight,
       colors = pv.Colors.category19();
   
     
   var force = vis.add(pv.Layout.Force)
       .nodes(items.nodes)
       .links(items.links)
       .springLength(200);
   
   force.link.add(pv.Line)
        .add(pv.Label)
          .text(function (d, e) e.relName)
          .data(function(p) [{
                x: (p.sourceNode.x + p.targetNode.x) / 2,
                y: (p.sourceNode.y + p.targetNode.y) / 2
                }]
                )
          .textAlign("center")
          .textBaseline("middle");
          
   
   force.node.add(pv.Bar)
      // .size(function(d) 100 * Math.pow(this.scale, -1.5))
       .width(120)
       .height(30)
       .fillStyle(function(d) d.fix ? "brown" : colors(d.group))
       .strokeStyle(function() this.fillStyle().darker())
       .lineWidth(1)
       
       .title(function(d) {return JSON.stringify(thingStore.lookup(d.uri))
        })
       .event("mousedown", pv.Behavior.drag())
       .event("click", function(d) {renderGraph(d.uri, tempNodes, tempLinks) })
       .event("drag", force)
       .anchor("center").add(pv.Label)
          .text( function (d) d.nodeName);
   
   vis.render();
   }
  // Initialise collections and set initial start item, then fetch data and render
  vis = new pv.Panel()
       .width(w)
       .height(h)
       .fillStyle("white")
       .event("mousedown", pv.Behavior.pan())
       .event("mousewheel", pv.Behavior.zoom());
  var startItem = 'uri:thing/person/graham';
  renderGraph (startItem, [], []);
    </script>
  </body>
</html>